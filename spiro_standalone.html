<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valores Previstos de Espirometria: Crianças de 3 a 12 anos (Standalone)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f4f8;
            color: #334155;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            padding: 40px;
            width: 100%;
            max-width: 1000px;
            box-sizing: border-box;
        }

        h1 {
            color: #1e293b;
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.2em;
            line-height: 1.2;
            font-weight: 700;
        }

        .form-row {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 0;
        }

        .form-row .input-group {
            flex: 1;
            min-width: 0;
            margin-bottom: 20px;
        }

        .form-row .input-group-wider {
            flex: 2;
        }

        .input-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 8px;
            color: #64748b;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group input[type="date"],
        .input-group select {
            padding: 12px 15px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #f8fafc;
        }

        .input-group input:focus,
        .input-group select:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-group select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .observed-values-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .observed-values-section h2 {
            color: #334155;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        .observed-values-group {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .observed-values-column {
            flex: 1;
            min-width: 280px;
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .observed-values-column h3 {
            margin-top: 0;
            color: #475569;
            font-size: 1.1em;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        button {
            background-color: #0ea5e9;
            color: white;
            padding: 16px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.2s, transform 0.1s;
            margin-top: 20px;
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.2);
        }

        button:hover {
            background-color: #0284c7;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        #results {
            margin-top: 40px;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        #results h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 10px;
        }

        .result-warning {
            background-color: #fef2f2;
            color: #ef4444;
            font-weight: 600;
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #fecaca;
            margin-bottom: 25px;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }

        .exam-details {
            text-align: left;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 0.95em;
        }

        .exam-details p {
            margin: 8px 0;
        }

        .exam-details strong {
            color: #334155;
            font-weight: 600;
        }

        .citation {
            font-style: italic;
            font-size: 0.85em;
            text-align: right;
            margin-top: 15px;
            margin-bottom: 25px;
            color: #64748b;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
            margin-bottom: 30px;
            font-size: 0.95em;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        table th,
        table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }

        table th {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.05em;
        }

        table tr:last-child td {
            border-bottom: none;
        }

        table tr:nth-child(even) {
            background-color: #f8fafc;
        }

        table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #334155;
            background-color: #fcfcfc;
        }

        .value-below-lin {
            color: #dc2626;
            font-weight: 700;
        }

        .change-significant-green {
            color: #16a34a;
            font-weight: 700;
        }

        #interpretation-unified-section {
            margin-top: 30px;
            padding: 25px;
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
        }

        .interpretation-editable {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1em;
            line-height: 1.6;
            resize: vertical;
            background-color: #fff;
            margin-top: 10px;
        }

        .action-buttons-group {
            margin-top: 40px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-buttons-group button {
            width: auto;
            flex-grow: 1;
            max-width: 200px;
            margin-top: 0;
            font-size: 1em;
            padding: 12px 20px;
        }

        #resetButton {
            background-color: #64748b;
        }

        #resetButton:hover {
            background-color: #475569;
        }

        #printButton {
            background-color: #0ea5e9;
        }

        #copyHtmlButton {
            background-color: #10b981;
        }

        #copyHtmlButton:hover {
            background-color: #059669;
        }

        .chart-container {
            margin-top: 40px;
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            height: 400px;
            position: relative;
        }

        .author-license-info {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            font-size: 0.75em;
            color: #94a3b8;
            line-height: 1.4;
        }

        .author-license-info p {
            margin: 4px 0;
        }

        .author-license-info a {
            color: #94a3b8;
            text-decoration: none;
            border-bottom: 1px dotted #94a3b8;
        }

        .author-license-info a:hover {
            color: #0ea5e9;
            border-bottom-color: #0ea5e9;
        }

        .license-small {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .doctor-signature {
            margin-top: 60px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .signature-line {
            border-top: 1px solid #334155;
            margin-bottom: 10px;
        }

        .doctor-signature p {
            margin: 5px 0;
            color: #334155;
            font-weight: 600;
            font-size: 1.1em;
        }

        .doctor-signature .signature-details {
            font-weight: 400;
            font-size: 0.95em;
            color: #475569;
            margin-top: 2px;
        }

        .doctor-signature .signature-label {
            font-size: 0.85em;
            color: #64748b;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @media print {
            body {
                background-color: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
                width: 100%;
                max-width: 100%;
            }

            .spirometry-form,
            .action-buttons-group,
            .result-warning,
            .error-message,
            .author-license-info {
                display: none !important;
            }

            #results {
                box-shadow: none;
                border: none;
                padding: 0;
                margin-top: 0;
            }

            .interpretation-editable {
                border: none;
                resize: none;
                padding: 0;
                background-color: transparent;
            }

            .chart-container {
                break-inside: avoid;
                height: 350px;
                /* Slightly larger for better visibility */
                border: none;
                /* Remove border for cleaner print */
                padding: 0;
                margin-top: 20px;
                width: 100%;
                display: block;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-row .input-group,
            .form-row .input-group-wider {
                flex-basis: 100%;
                flex-grow: 1;
            }
        }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
</head>

<body>
    <div class="container">
        <h1>Valores Previstos de Espirometria<br>Crianças de 3 a 12 anos</h1>

        <form id="spirometryForm" class="spirometry-form">
            <div class="form-row">
                <div class="input-group input-group-wider">
                    <label for="patientName">Nome do Paciente:</label>
                    <input type="text" id="patientName" required>
                    <div class="error-message" id="patientNameError">Nome do paciente é obrigatório.</div>
                </div>
                <div class="input-group">
                    <label for="examDate">Data do Exame:</label>
                    <input type="date" id="examDate" required>
                    <div class="error-message" id="examDateError">Data do exame é obrigatória.</div>
                </div>
            </div>
            <div class="form-row">
                <div class="input-group">
                    <label for="ageYears">Idade (anos):</label>
                    <input type="number" id="ageYears" min="3" max="12" step="1" required>
                    <div class="error-message" id="ageError">A idade deve estar entre 3 e 12 anos.</div>
                </div>
                <div class="input-group">
                    <label for="ageMonths">Idade (meses, opcional):</label>
                    <input type="number" id="ageMonths" min="0" max="11" step="1" value="0">
                    <div class="error-message" id="ageMonthsError">Os meses devem estar entre 0 e 11.</div>
                </div>
            </div>
            <div class="form-row">
                <div class="input-group">
                    <label for="heightCm">Altura (cm):</label>
                    <input type="number" id="heightCm" min="50" max="200" step="0.1" required>
                    <div class="error-message" id="heightError">A altura deve ser um valor válido em cm.</div>
                </div>
                <div class="input-group">
                    <label for="weightKg">Peso (Kg):</label>
                    <input type="number" id="weightKg" min="10" max="200" step="0.1" required>
                    <div class="error-message" id="weightError">O peso deve ser um valor válido em Kg.</div>
                </div>
            </div>
            <div class="form-row">
                <div class="input-group">
                    <label for="gender">Sexo:</label>
                    <select id="gender" required>
                        <option value="">Selecione</option>
                        <option value="male">Masculino</option>
                        <option value="female">Feminino</option>
                    </select>
                    <div class="error-message" id="genderError">Selecione o sexo.</div>
                </div>
                <div class="input-group">
                    <label for="colorCode">Cor:</label>
                    <select id="colorCode" required>
                        <option value="">Selecione</option>
                        <option value="0">Branco</option>
                        <option value="1">Negro ou Pardo</option>
                    </select>
                    <div class="error-message" id="colorCodeError">Selecione a cor.</div>
                </div>
            </div>
            <div class="form-row">
                <div class="input-group input-group-wider">
                    <label for="diagnosis">Diagnóstico:</label>
                    <select id="diagnosis" required>
                        <option value="">Selecione</option>
                        <option value="em investigação">Em investigação</option>
                        <option value="Asma">Asma</option>
                        <option value="Fibrose Cística">Fibrose Cística</option>
                        <option value="Discinesia Ciliar Primária">Discinesia Ciliar Primária</option>
                        <option value="Doença pulmonar intersticial">Doença pulmonar intersticial</option>
                        <option value="Bronquiectasias">Bronquiectasias</option>
                        <option value="Doença Pulmonar Supurativa Crônica">Doença Pulmonar Supurativa Crônica
                        </option>
                        <option value="Doença Pulmonar Crônica da Prematuridade">Doença Pulmonar Crônica da
                            Prematuridade</option>
                        <option value="Outros Diagnósticos">Outros Diagnósticos</option>
                        <option value="Sadio e Assintomático">Sadio e Assintomático</option>
                    </select>
                    <div class="error-message" id="diagnosisError">Selecione o diagnóstico.</div>
                </div>
            </div>
            <div class="form-row">
                <div class="input-group input-group-wider">
                    <label for="doctorName">Nome do Médico:</label>
                    <input type="text" id="doctorName" required>
                    <div class="error-message" id="doctorNameError">Nome do médico é obrigatório.</div>
                </div>
            </div>
            <div class="form-row">
                <div class="input-group">
                    <label for="doctorCRM">CRM:</label>
                    <input type="text" id="doctorCRM">
                </div>
                <div class="input-group">
                    <label for="doctorSpecialty">Especialidade:</label>
                    <input type="text" id="doctorSpecialty">
                </div>
            </div>
            <div class="form-row">
                <div class="input-group input-group-wider">
                    <label for="clinicName">Clínica:</label>
                    <input type="text" id="clinicName" required>
                    <div class="error-message" id="clinicNameError">Nome da clínica é obrigatório.</div>
                </div>
            </div>

            <div class="observed-values-section">
                <h2>Valores Observados</h2>
                <div class="observed-values-group">
                    <div class="observed-values-column">
                        <h3>Pré-Broncodilatador</h3>
                        <div class="input-group">
                            <label for="obsCVF_pre">CVF (L):</label>
                            <input type="number" id="obsCVF_pre" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="obsVEF1_pre">VEF1 (L):</label>
                            <input type="number" id="obsVEF1_pre" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="obsFEF2575_pre">FEF25-75% (L/s):</label>
                            <input type="number" id="obsFEF2575_pre" step="0.01">
                        </div>
                    </div>
                    <div class="observed-values-column" id="postBdColumn">
                        <h3>Pós-Broncodilatador</h3>
                        <div class="input-group">
                            <label for="obsCVF_post">CVF (L):</label>
                            <input type="number" id="obsCVF_post" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="obsVEF1_post">VEF1 (L):</label>
                            <input type="number" id="obsVEF1_post" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="obsFEF2575_post">FEF25-75% (L/s):</label>
                            <input type="number" id="obsFEF2575_post" step="0.01">
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit">Calcular Espirometria</button>
        </form>

        <div id="results" style="display: none;">
            <div class="result-warning" id="healthyOlderMessage"
                style="display: none; background-color: #d1fae5; color: #065f46; border-color: #34d399;">
                Paciente Sadio (> 12 anos). Dados salvos com sucesso. Sem cálculo de previstos disponível para esta
                faixa etária.
            </div>
            <div class="result-warning" id="ageRangeWarning" style="display: none;">
                Atenção: A idade da criança está fora da faixa recomendada (3 a 12 anos, 11 meses e 29 dias). Os
                resultados podem não ser precisos.
            </div>

            <div class="exam-details">
                <p><strong>Paciente:</strong> <span id="displayPatientName"></span> - <strong>Idade:</strong> <span
                        id="displayPatientAge"></span> - <strong>Altura:</strong> <span
                        id="displayPatientHeight"></span> - <strong>Peso:</strong> <span
                        id="displayPatientWeight"></span></p>
                <p><strong>Data do Exame:</strong> <span id="displayExamDate"></span></p>
                <p><strong>Médico Responsável:</strong> <span id="displayDoctorName"></span></p>
                <p><strong>Clínica:</strong> <span id="displayClinicName"></span></p>
            </div>

            <h2>Resultados Pré-Broncodilatador</h2>
            <table>
                <thead>
                    <tr>
                        <th>Variável</th>
                        <th>Observado</th>
                        <th>Previsto</th>
                        <th>LIN</th>
                        <th>% do Previsto</th>
                        <th>Z-score</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBodyPre"></tbody>
            </table>

            <div id="postBdSection" style="display: none;">
                <h2>Resultados Pós-Broncodilatador e Reversibilidade</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Variável</th>
                            <th>Observado Pós-BD</th>
                            <th>% do Previsto Pós-BD</th>
                            <th>Z-score Pós-BD</th>
                            <th>Dif. Abs.</th>
                            <th>Dif. % do Previsto</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBodyPostAndReversibility"></tbody>
                </table>
            </div>

            <p class="citation">Valores previstos: Jones et al. Jornal Brasileiro de Pneumologia, 2020</p>

            <div class="chart-container">
                <canvas id="spirometryChart"></canvas>
            </div>

            <div id="interpretation-unified-section">
                <h2>Interpretação</h2>
                <textarea id="interpretation-text-pre" class="interpretation-editable"
                    placeholder="Interpretação Pré-BD"></textarea>
                <textarea id="interpretation-text-post" class="interpretation-editable" style="display: none;"
                    placeholder="Interpretação Pós-BD"></textarea>

                <div id="conclusion-section" style="margin-top: 20px;">
                    <h3>Conclusão</h3>
                    <textarea id="conclusion-text" class="interpretation-editable" placeholder="Conclusão"></textarea>
                </div>

                <div class="doctor-signature" id="doctorSignatureBlock" style="display: none;">
                    <div class="signature-line"></div>
                    <p id="signatureDoctorName"></p>
                    <p id="signatureDoctorDetails" class="signature-details"></p>
                </div>
            </div>

            <div class="action-buttons-group">
                <button type="button" id="exportDbButton" class="action-button"
                    style="background-color: #4CAF50; color: white;">Exportar Banco de Dados (CSV)</button>
                <button type="button" id="sendHealthyButton" class="action-button"
                    style="background-color: #8e44ad; color: white; display: none;">Enviar Dados (Sadios)</button>
                <button type="button" id="printButton">Imprimir (PDF)</button>
                <button type="button" id="copyHtmlButton">Copiar Resultados (HTML)</button>
                <button type="button" id="resetButton">Novo Exame</button>
            </div>

            <div class="author-license-info">
                <p>Desenvolvido por <a href="mailto:marcushjones@gmail.com?subject=Feedback%20Spiro3a12">Marcus H
                        Jones</a>
                </p>
                <p class="license-small">Versão 1.19 | CC BY-ND 4.0</p>
            </div>
        </div>
    </div>
    <script>
        // --- calculations.js content ---
        // Coefficients for Predicted Values (Jones et al. 2020)
        const coefMalePrev = {
            intercept: { cvf: -11.358191, vef1: -10.434226, vef1cvf: 1.760961, fef2575: -6.957857, fef2575cvf: 6.185501 },
            lnAltura: { cvf: 2.419817, vef1: 2.207609, vef1cvf: -0.176748, fef2575: 1.527303, fef2575cvf: -1.044205 },
            lnIdade: { cvf: 0.115477, vef1: 0.114001, vef1cvf: 0, fef2575: 0.138649, fef2575cvf: 0 },
            cor: { cvf: -0.028745, vef1: -0.031836, vef1cvf: 0, fef2575: 0, fef2575cvf: 0.093297 }
        };

        const coefFemalePrev = {
            intercept: { cvf: -10.741935, vef1: -9.967774, vef1cvf: 1.437685, fef2575: -7.385469, fef2575cvf: 5.041747 },
            lnAltura: { cvf: 2.261976, vef1: 2.08895, vef1cvf: -0.106215, fef2575: 1.594033, fef2575cvf: -0.785773 },
            lnIdade: { cvf: 0.156836, vef1: 0.150386, vef1cvf: 0, fef2575: 0.203576, fef2575cvf: 0 },
            cor: { cvf: -0.041015, vef1: -0.048582, vef1cvf: 0, fef2575: 0, fef2575cvf: 0.046472 }
        };

        const coefMaleLIN = {
            intercept: { cvf: -9.32749, vef1: -8.960184, vef1cvf: 1.94278, fef2575: -5.356269, fef2575cvf: 4.579022 },
            lnAltura: { cvf: 1.890179, vef1: 1.820202, vef1cvf: -0.231255, fef2575: 1.085145, fef2575cvf: -0.78661 },
            lnIdade: { cvf: 0.268924, vef1: 0.208981, vef1cvf: 0, fef2575: 0.211021, fef2575cvf: 0 },
            cor: { cvf: -0.042377, vef1: -0.026383, vef1cvf: 0, fef2575: 0, fef2575cvf: 0.036968 }
        };

        const coefFemaleLIN = {
            intercept: { cvf: -10.325884, vef1: -8.934018, vef1cvf: 1.313149, fef2575: -7.85519, fef2575cvf: 3.919387 },
            lnAltura: { cvf: 2.098703, vef1: 1.768038, vef1cvf: -0.100805, fef2575: 1.673427, fef2575cvf: -0.642607 },
            lnIdade: { cvf: 0.23022, vef1: 0.290733, vef1cvf: 0, fef2575: 0.056126, fef2575cvf: 0 },
            cor: { cvf: -0.073692, vef1: -0.054695, vef1cvf: 0, fef2575: 0, fef2575cvf: 0.027623 }
        };

        const seeMale = { cvf: 0.1362, vef1: 0.1284, vef1cvf: 0.04988, fef2575: 0.224, fef2575cvf: 0.2694 };
        const seeFemale = { cvf: 0.1443, vef1: 0.1369, vef1cvf: 0.05075, fef2575: 0.2297, fef2575cvf: 0.2929 };

        const calculatePredictedValues = (coefsPrev, lnHeight, lnAge, colorCode) => {
            const lnPrevCVF = coefsPrev.intercept.cvf + (lnHeight * coefsPrev.lnAltura.cvf) + (lnAge * coefsPrev.lnIdade.cvf) + (colorCode * coefsPrev.cor.cvf);
            const prevCVF = Math.exp(lnPrevCVF);
            const lnPrevVEF1 = coefsPrev.intercept.vef1 + (lnHeight * coefsPrev.lnAltura.vef1) + (lnAge * coefsPrev.lnIdade.vef1) + (colorCode * coefsPrev.cor.vef1);
            const prevVEF1 = Math.exp(lnPrevVEF1);
            const prevVEF1CVF = coefsPrev.intercept.vef1cvf + (lnHeight * coefsPrev.lnAltura.vef1cvf) + (lnAge * coefsPrev.lnIdade.vef1cvf) + (colorCode * coefsPrev.cor.vef1cvf);
            const lnPrevFEF2575 = coefsPrev.intercept.fef2575 + (lnHeight * coefsPrev.lnAltura.fef2575) + (lnAge * coefsPrev.lnIdade.fef2575) + (colorCode * coefsPrev.cor.fef2575);
            const prevFEF2575 = Math.exp(lnPrevFEF2575);
            const prevFEF2575CVF = coefsPrev.intercept.fef2575cvf + (lnHeight * coefsPrev.lnAltura.fef2575cvf) + (lnAge * coefsPrev.lnIdade.fef2575cvf) + (colorCode * coefsPrev.cor.fef2575cvf);
            return { prevCVF, prevVEF1, prevVEF1CVF, prevFEF2575, prevFEF2575CVF, lnPrevCVF, lnPrevVEF1, lnPrevFEF2575 };
        };

        const calculateLINValues = (coefsLIN, lnHeight, lnAge, colorCode) => {
            const lnLINCVF = coefsLIN.intercept.cvf + (lnHeight * coefsLIN.lnAltura.cvf) + (lnAge * coefsLIN.lnIdade.cvf) + (colorCode * coefsLIN.cor.cvf);
            const linCVF = Math.exp(lnLINCVF);
            const lnLINVEF1 = coefsLIN.intercept.vef1 + (lnHeight * coefsLIN.lnAltura.vef1) + (lnAge * coefsLIN.lnIdade.vef1) + (colorCode * coefsLIN.cor.vef1);
            const linVEF1 = Math.exp(lnLINVEF1);
            const linVEF1CVF = coefsLIN.intercept.vef1cvf + (lnHeight * coefsLIN.lnAltura.vef1cvf) + (lnAge * coefsLIN.lnIdade.vef1cvf) + (colorCode * coefsLIN.cor.vef1cvf);
            const lnLINFEF2575 = coefsLIN.intercept.fef2575 + (lnHeight * coefsLIN.lnAltura.fef2575) + (lnAge * coefsLIN.lnIdade.fef2575) + (colorCode * coefsLIN.cor.fef2575);
            const linFEF2575 = Math.exp(lnLINFEF2575);
            const linFEF2575CVF = coefsLIN.intercept.fef2575cvf + (lnHeight * coefsLIN.lnAltura.fef2575cvf) + (lnAge * coefsLIN.lnIdade.fef2575cvf) + (colorCode * coefsLIN.cor.fef2575cvf);
            return { linCVF, linVEF1, linVEF1CVF, linFEF2575, linFEF2575CVF };
        };

        const computeDerivedObserved = (obsVEF1, obsCVF, obsFEF2575) => {
            const computedObsVEF1CVF = (obsVEF1 !== null && obsCVF !== null && obsCVF !== 0) ? (obsVEF1 / obsCVF) : null;
            return { computedObsVEF1CVF };
        };

        const calculateZScore = (obsVal, prevValRaw, seeVal, isLogTransformed) => {
            if (obsVal === null || isNaN(obsVal) || prevValRaw === null || isNaN(prevValRaw) || seeVal === 0 || isNaN(seeVal)) return null;
            let numerator;
            if (isLogTransformed) {
                if (obsVal <= 0) return null;
                numerator = Math.log(obsVal) - Math.log(prevValRaw);
            } else {
                numerator = obsVal - prevValRaw;
            }
            return numerator / seeVal;
        };

        const calculatePercentage = (observed, predicted) => {
            if (observed === null || isNaN(observed) || predicted === null || isNaN(predicted) || predicted === 0) return 'N/A';
            return ((observed / predicted) * 100).toFixed(2);
        };

        const calculateDiffPercentOfPredicted = (obsPre, obsPost, predicted) => {
            if (obsPre === null || obsPost === null || isNaN(obsPre) || isNaN(obsPost) || predicted === null || isNaN(predicted) || predicted === 0) return null;
            const absDiff = obsPost - obsPre;
            return (absDiff / predicted) * 100;
        };

        const formatValue = (value, decimals = 2) => value === null || isNaN(value) ? 'N/A' : value.toFixed(decimals);

        const generateSingleInterpretation = (obsCVF, linCVF, obsVEF1, linVEF1, computedObsVEF1CVF, linVEF1CVF, zScoreCVF, label, classPreBD = null, obsCVF_pre_param = null, obsVEF1_pre_param = null, prevCVF_param = null, prevVEF1_param = null) => {
            let baseInterpretationText = "";
            let calculatedClassification = "Sem Classificação";

            const isCVFValid = obsCVF !== null && !isNaN(obsCVF);
            const isVEF1Valid = obsVEF1 !== null && !isNaN(obsVEF1);
            const isVEF1CVFValid = computedObsVEF1CVF !== null && !isNaN(computedObsVEF1CVF);
            const isZScoreCVFValid = zScoreCVF !== null && !isNaN(zScoreCVF);

            if (isCVFValid && isVEF1Valid && isVEF1CVFValid) {
                if (obsCVF >= linCVF && obsVEF1 >= linVEF1 && computedObsVEF1CVF >= linVEF1CVF) {
                    calculatedClassification = "Normal";
                    baseInterpretationText = `Todos os parâmetros (CVF: ${formatValue(obsCVF)} L, VEF1: ${formatValue(obsVEF1)} L, VEF1/CVF: ${formatValue(computedObsVEF1CVF, 3)}) encontram-se dentro dos limites da normalidade. Função pulmonar normal.`;
                } else if (isZScoreCVFValid && zScoreCVF >= 1 && isVEF1Valid && obsVEF1 > linVEF1 && computedObsVEF1CVF < linVEF1CVF) {
                    calculatedClassification = "Considerar Disanapsis";
                    baseInterpretationText = `CVF com Z-score >= 1 (Z-score CVF: ${formatValue(zScoreCVF, 2)}), VEF1 acima do LIN (${formatValue(obsVEF1)} L), mas a relação VEF1/CVF está reduzida (${formatValue(computedObsVEF1CVF, 3)}). Estes achados podem sugerir disanapsis (desproporção entre o tamanho das vias aéreas e o volume pulmonar). Recomenda-se correlação clínica.`;
                } else if (obsCVF >= linCVF && computedObsVEF1CVF < linVEF1CVF) {
                    calculatedClassification = "Obstrutivo";
                    baseInterpretationText = `CVF encontra-se dentro da normalidade (${formatValue(obsCVF)} L), mas o índice VEF1/CVF está abaixo do LIN (${formatValue(computedObsVEF1CVF, 3)}). Isto é compatível com um padrão obstrutivo.`;
                } else if (obsCVF < linCVF && isVEF1Valid && obsVEF1 < linVEF1 && computedObsVEF1CVF >= linVEF1CVF) {
                    calculatedClassification = "Restritivo";
                    baseInterpretationText = `A Capacidade Vital Forçada (CVF: ${formatValue(obsCVF)} L) e o Volume Expiratório Forçado no primeiro segundo (VEF1: ${formatValue(obsVEF1)} L) estão abaixo do LIN, mas o índice VEF1/CVF (${formatValue(computedObsVEF1CVF, 3)}) está dentro da normalidade. Isto sugere um padrão restritivo.`;
                } else if (obsCVF < linCVF && computedObsVEF1CVF < linVEF1CVF) {
                    calculatedClassification = "Misto";
                    baseInterpretationText = `Tanto o CVF (${formatValue(obsCVF)} L) quanto o índice VEF1/CVF (${formatValue(computedObsVEF1CVF, 3)}) estão abaixo do LIN. Isto indica um padrão misto (obstrutivo e restritivo).`;
                } else {
                    baseInterpretationText = "A combinação dos resultados não se enquadra claramente nos padrões definidos acima. Avaliação clínica detalhada é recomendada.";
                }
            } else {
                baseInterpretationText = "Não foi possível classificar devido a dados insuficientes para os parâmetros chave (CVF, VEF1, VEF1/CVF).";
                calculatedClassification = "Dados Insuficientes";
            }

            let postBdSpecificText = "";
            if (label === "Pós-Broncodilatador") {
                let postBdCommentsArray = [];

                if (calculatedClassification === "Normal" && classPreBD !== null && classPreBD !== "Normal") {
                    postBdCommentsArray.push("Houve normalização da função pulmonar global após o uso do broncodilatador.");
                }

                if (obsCVF_pre_param !== null && linCVF !== null && obsCVF_pre_param < linCVF && obsCVF !== null && obsCVF >= linCVF) {
                    postBdCommentsArray.push("Houve normalização da CVF (que estava reduzida) após o broncodilatador.");
                } else if (obsCVF !== null && linCVF !== null && obsCVF >= linCVF && !(obsCVF_pre_param !== null && obsCVF_pre_param >= linCVF)) {
                    postBdCommentsArray.push("A CVF encontra-se dentro dos limites da normalidade após o broncodilatador.");
                }

                let vef1Reversible = false;
                let cvfReversible = false;
                let reversibilityTitle = "Resposta ao broncodilatador:";
                let individualResponseStatements = [];

                if (obsVEF1_pre_param !== null && obsVEF1 !== null && prevVEF1_param !== null && prevVEF1_param !== 0) {
                    const varVEF1PercPrev = calculateDiffPercentOfPredicted(obsVEF1_pre_param, obsVEF1, prevVEF1_param);
                    if (varVEF1PercPrev !== null) {
                        if (varVEF1PercPrev >= 10) {
                            vef1Reversible = true;
                            individualResponseStatements.push(`O VEF1 apresentou resposta significativa (${formatValue(varVEF1PercPrev, 1)}% do previsto).`);
                        } else {
                            individualResponseStatements.push(`O VEF1 apresentou variação não significativa de ${formatValue(varVEF1PercPrev, 1)}% do previsto.`);
                        }
                    }
                }

                if (obsCVF_pre_param !== null && obsCVF !== null && prevCVF_param !== null && prevCVF_param !== 0) {
                    const varCVFPercPrev = calculateDiffPercentOfPredicted(obsCVF_pre_param, obsCVF, prevCVF_param);
                    if (varCVFPercPrev !== null) {
                        let cvfStatementForPush = "";
                        if (varCVFPercPrev >= 10) {
                            cvfReversible = true;
                            cvfStatementForPush = `A CVF apresentou resposta significativa (${formatValue(varCVFPercPrev, 1)}% do previsto).`;
                            cvfStatementForPush += " Esta resposta na CVF sugere a presença de aprisionamento aéreo na fase pré-broncodilatador.";
                            if (classPreBD === "Misto") {
                                cvfStatementForPush += " Sendo o padrão Pré-BD classificado como Misto, esta melhora da CVF Pós-BD sugere redução do aprisionamento de ar.";
                            }
                        } else {
                            cvfStatementForPush = `A CVF apresentou variação não significativa de ${formatValue(varCVFPercPrev, 1)}% do previsto.`;
                        }
                        individualResponseStatements.push(cvfStatementForPush);
                    }
                }

                if (individualResponseStatements.length > 0) {
                    postBdCommentsArray.push(reversibilityTitle + "<br>" + individualResponseStatements.join("<br>"));
                }

                if (postBdCommentsArray.length > 0) {
                    postBdSpecificText = "<br><br>" + postBdCommentsArray.join("<br><br>");
                }
            }

            const classificationHTML = `<strong>Classificação (${label}): ${calculatedClassification}</strong><br><br>`;
            return {
                text: classificationHTML + baseInterpretationText + postBdSpecificText,
                classification: calculatedClassification
            };
        };

        const generateConclusion = (preClassification, postClassification, vef1ChangePercent, cvfChangePercent) => {
            let conclusion = "";

            if (preClassification === "Normal") {
                conclusion = "Espirometria dentro dos limites da normalidade.";
            } else if (preClassification === "Obstrutivo") {
                conclusion = "Distúrbio ventilatório obstrutivo.";
            } else if (preClassification === "Restritivo") {
                conclusion = "Distúrbio ventilatório restritivo.";
            } else if (preClassification === "Misto") {
                conclusion = "Distúrbio ventilatório misto (obstrutivo e restritivo).";
            } else if (preClassification === "Considerar Disanapsis") {
                conclusion = "Espirometria sugestiva de Disanapsis (desproporção via aérea/parênquima).";
            } else {
                conclusion = "Alterações ventilatórias inespecíficas.";
            }

            if (postClassification) {
                const significantVEF1 = vef1ChangePercent !== null && vef1ChangePercent >= 10;
                const significantCVF = cvfChangePercent !== null && cvfChangePercent >= 10;

                if (significantVEF1 || significantCVF) {
                    conclusion += " Resposta significativa ao broncodilatador";
                    if (significantVEF1 && significantCVF) conclusion += " (VEF1 e CVF).";
                    else if (significantVEF1) conclusion += " (VEF1).";
                    else if (significantCVF) conclusion += " (CVF).";

                    if (postClassification === "Normal") {
                        conclusion += " Normalização completa dos fluxos e volumes após broncodilatador.";
                    }
                } else {
                    conclusion += " Prova broncodilatadora negativa (sem variação significativa de fluxos ou volumes).";
                }
            }

            return conclusion;
        };

        // --- renderer.js content ---

        let spirometryChart = null;
        let currentExamId = null; // Defined globally for Auto-Save

        // Auto-Save Function
        const autoSaveExam = () => {
            const getVal = (id) => document.getElementById(id).value;
            // No need for getNum here as we store strings for CSV

            const examData = {
                id: currentExamId || Date.now(), // Use existing ID or create new one
                timestamp: new Date().toISOString(),
                patientName: getVal('patientName'),
                examDate: getVal('examDate'),
                ageYears: getVal('ageYears'),
                ageMonths: getVal('ageMonths'),
                heightCm: getVal('heightCm'),
                weightKg: getVal('weightKg'),
                gender: getVal('gender'),
                colorCode: getVal('colorCode'),
                diagnosis: getVal('diagnosis'),
                doctorName: getVal('doctorName'),
                doctorCRM: getVal('doctorCRM'),
                clinicName: getVal('clinicName'),
                // Pre-BD
                obsCVF_pre: getVal('obsCVF_pre'),
                obsVEF1_pre: getVal('obsVEF1_pre'),
                obsFEF2575_pre: getVal('obsFEF2575_pre'),
                // Post-BD
                obsCVF_post: getVal('obsCVF_post'),
                obsVEF1_post: getVal('obsVEF1_post'),
                obsFEF2575_post: getVal('obsFEF2575_post'),
                // Interpretation
                conclusion: getVal('conclusion-text')
            };

            let database = JSON.parse(localStorage.getItem('spiroDatabase') || '[]');

            if (currentExamId) {
                // Update existing record
                const index = database.findIndex(item => item.id === currentExamId);
                if (index !== -1) {
                    database[index] = examData;
                } else {
                    // Should not happen, but fallback to push
                    database.push(examData);
                }
            } else {
                // New record
                currentExamId = examData.id;
                database.push(examData);
            }

            localStorage.setItem('spiroDatabase', JSON.stringify(database));
            // Optional: console.log('Auto-saved exam:', currentExamId);
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Restore saved values
            const savedDoctorName = localStorage.getItem('doctorName');
            if (savedDoctorName) document.getElementById('doctorName').value = savedDoctorName;
            const savedCRM = localStorage.getItem('doctorCRM');
            if (savedCRM) document.getElementById('doctorCRM').value = savedCRM;
            const savedSpecialty = localStorage.getItem('doctorSpecialty');
            if (savedSpecialty) document.getElementById('doctorSpecialty').value = savedSpecialty;
            const savedClinicName = localStorage.getItem('clinicName');
            if (savedClinicName) document.getElementById('clinicName').value = savedClinicName;

            // Set today's date
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('examDate').value = `${yyyy}-${mm}-${dd}`;

            // Initialize Chart (Scatterplot)
            const ctx = document.getElementById('spirometryChart').getContext('2d');
            spirometryChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Z-Score VEF1/CVF' },
                            min: -4,
                            max: 4,
                            grid: {
                                color: (context) => context.tick.value === -1.645 ? 'rgba(0,0,0,0.5)' : 'rgba(0,0,0,0.1)',
                                lineWidth: (context) => context.tick.value === -1.645 ? 2 : 1
                            }
                        },
                        y: {
                            title: { display: true, text: 'Z-Score CVF' },
                            min: -4,
                            max: 4,
                            grid: {
                                color: (context) => context.tick.value === -1.645 ? 'rgba(0,0,0,0.5)' : 'rgba(0,0,0,0.1)',
                                lineWidth: (context) => context.tick.value === -1.645 ? 2 : 1
                            }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                normal: {
                                    type: 'box',
                                    xMin: -1.645, xMax: 4,
                                    yMin: -1.645, yMax: 4,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    label: { content: 'Normal', display: true, position: 'center' }
                                },
                                obstructive: {
                                    type: 'box',
                                    xMin: -4, xMax: -1.645,
                                    yMin: -1.645, yMax: 4,
                                    backgroundColor: 'rgba(255, 205, 86, 0.2)',
                                    label: { content: 'Obstrutivo', display: true, position: 'center' }
                                },
                                restrictive: {
                                    type: 'box',
                                    xMin: -1.645, xMax: 4,
                                    yMin: -4, yMax: -1.645,
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    label: { content: 'Restritivo', display: true, position: 'center' }
                                },
                                mixed: {
                                    type: 'box',
                                    xMin: -4, xMax: -1.645,
                                    yMin: -4, yMax: -1.645,
                                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                    label: { content: 'Misto', display: true, position: 'center' }
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return `${context.dataset.label}: (${context.parsed.x.toFixed(2)}, ${context.parsed.y.toFixed(2)})`;
                                }
                            }
                        }
                    }
                }
            });

            // Logic to hide Post-BD for Healthy Patients
            document.getElementById('diagnosis').addEventListener('change', function () {
                const isHealthy = this.value === "Sadio e Assintomático";
                const postBdColumn = document.getElementById('postBdColumn');
                if (isHealthy) {
                    postBdColumn.style.display = 'none';
                    // Clear values to avoid confusion
                    document.getElementById('obsCVF_post').value = '';
                    document.getElementById('obsVEF1_post').value = '';
                    document.getElementById('obsFEF2575_post').value = '';
                } else {
                    postBdColumn.style.display = 'block';
                }
            });
        });

        document.getElementById('doctorName').addEventListener('input', (e) => localStorage.setItem('doctorName', e.target.value));
        document.getElementById('doctorCRM').addEventListener('input', (e) => localStorage.setItem('doctorCRM', e.target.value));
        document.getElementById('doctorSpecialty').addEventListener('input', (e) => localStorage.setItem('doctorSpecialty', e.target.value));
        document.getElementById('clinicName').addEventListener('input', (e) => localStorage.setItem('clinicName', e.target.value));

        document.getElementById('spirometryForm').addEventListener('submit', function (event) {
            event.preventDefault();

            // Reset errors and warnings
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.getElementById('ageRangeWarning').style.display = 'none';
            document.getElementById('healthyOlderMessage').style.display = 'none';

            let isValid = true;
            const getVal = (id) => document.getElementById(id).value;
            const getNum = (id) => parseFloat(document.getElementById(id).value);

            const patientName = getVal('patientName').trim();
            const examDateInput = getVal('examDate');
            const doctorName = getVal('doctorName').trim();
            const doctorCRM = getVal('doctorCRM').trim();
            const doctorSpecialty = getVal('doctorSpecialty').trim();
            const clinicName = getVal('clinicName').trim();
            const ageYears = getNum('ageYears');
            const ageMonths = getNum('ageMonths');
            const heightCm = getNum('heightCm');
            const weightKg = getNum('weightKg');
            const gender = getVal('gender');
            const colorCode = getNum('colorCode');
            const diagnosis = getVal('diagnosis');

            const obsCVF_pre = getNum('obsCVF_pre') || null;
            const obsVEF1_pre = getNum('obsVEF1_pre') || null;
            const obsFEF2575_pre = getNum('obsFEF2575_pre') || null;

            const obsCVF_post = getNum('obsCVF_post') || null;
            const obsVEF1_post = getNum('obsVEF1_post') || null;
            const obsFEF2575_post = getNum('obsFEF2575_post') || null;

            // Validation
            if (!patientName) { document.getElementById('patientNameError').style.display = 'block'; isValid = false; }
            if (!examDateInput) { document.getElementById('examDateError').style.display = 'block'; isValid = false; }
            if (!doctorName) { document.getElementById('doctorNameError').style.display = 'block'; isValid = false; }
            if (!clinicName) { document.getElementById('clinicNameError').style.display = 'block'; isValid = false; }
            if (!clinicName) { document.getElementById('clinicNameError').style.display = 'block'; isValid = false; }

            // Age validation: 3-12 normally, 3-99 for "Sadio e Assintomático"
            const maxAge = diagnosis === "Sadio e Assintomático" ? 99 : 12;
            if (isNaN(ageYears) || ageYears < 3 || ageYears > maxAge) {
                document.getElementById('ageError').textContent = `A idade deve estar entre 3 e ${maxAge} anos.`;
                document.getElementById('ageError').style.display = 'block';
                isValid = false;
            }

            if (isNaN(ageMonths) || ageMonths < 0 || ageMonths > 11) { document.getElementById('ageMonthsError').style.display = 'block'; isValid = false; }
            if (isNaN(heightCm) || heightCm <= 0) { document.getElementById('heightError').style.display = 'block'; isValid = false; }
            if (isNaN(weightKg) || weightKg <= 0) { document.getElementById('weightError').style.display = 'block'; isValid = false; }
            if (gender === "") { document.getElementById('genderError').style.display = 'block'; isValid = false; }
            if (isNaN(colorCode)) { document.getElementById('colorCodeError').style.display = 'block'; isValid = false; }
            if (getVal('diagnosis') === "") { document.getElementById('diagnosisError').style.display = 'block'; isValid = false; }

            if (!isValid) {
                document.getElementById('results').style.display = 'none';
                return;
            }

            // Display Header Info
            document.getElementById('displayPatientName').textContent = patientName;
            document.getElementById('displayPatientAge').textContent = `${ageYears} anos` + (ageMonths > 0 ? ` e ${ageMonths} meses` : '');
            document.getElementById('displayPatientHeight').textContent = formatValue(heightCm, 1) + ' cm';
            document.getElementById('displayPatientWeight').textContent = formatValue(weightKg, 1) + ' Kg';
            const dateParts = examDateInput.split('-');
            document.getElementById('displayExamDate').textContent = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            document.getElementById('displayDoctorName').textContent = doctorName;
            document.getElementById('displayClinicName').textContent = clinicName;

            // Calculations
            const totalAgeInYears = ageYears + (ageMonths / 12);
            const lnAge = Math.log(totalAgeInYears);
            const lnHeight = Math.log(heightCm);

            // Special logic for Healthy Patients >= 13
            if (diagnosis === "Sadio e Assintomático" && totalAgeInYears >= 13) {
                // Skip calculations, show success message
                document.getElementById('healthyOlderMessage').style.display = 'block';

                // Hide standard result sections
                document.querySelector('#results table').style.display = 'none'; // Pre table
                document.querySelector('#results h2').style.display = 'none'; // "Resultados Pré..."
                document.getElementById('postBdSection').style.display = 'none';
                document.querySelector('.citation').style.display = 'none';
                document.querySelector('.chart-container').style.display = 'none';
                document.getElementById('interpretation-unified-section').style.display = 'none';

                // Show "Enviar Dados" button
                document.getElementById('sendHealthyButton').style.display = 'inline-block';
                document.getElementById('printButton').style.display = 'none'; // Usually not needed for just saving?
                document.getElementById('copyHtmlButton').style.display = 'none';

                document.getElementById('results').style.display = 'block';
                document.getElementById('spirometryForm').style.display = 'none';

                autoSaveExam();
                return; // Exit function
            }

            // Reset visibility for standard patients (in case it was hidden)
            document.querySelector('#results table').style.display = 'table';
            document.querySelector('#results h2').style.display = 'block';
            document.querySelector('.citation').style.display = 'block';
            document.querySelector('.chart-container').style.display = 'block';
            document.getElementById('interpretation-unified-section').style.display = 'block';
            document.getElementById('printButton').style.display = 'inline-block';
            document.getElementById('copyHtmlButton').style.display = 'inline-block';

            if (totalAgeInYears < 3 || totalAgeInYears >= 13) {
                document.getElementById('ageRangeWarning').style.display = 'block';
            }

            const currentCoefsPrev = gender === 'male' ? coefMalePrev : coefFemalePrev;
            const currentCoefsLIN = gender === 'male' ? coefMaleLIN : coefFemaleLIN;
            const currentSEE = gender === 'male' ? seeMale : seeFemale;

            const { prevCVF, prevVEF1, prevVEF1CVF, prevFEF2575 } = calculatePredictedValues(currentCoefsPrev, lnHeight, lnAge, colorCode);
            const { linCVF, linVEF1, linVEF1CVF, linFEF2575 } = calculateLINValues(currentCoefsLIN, lnHeight, lnAge, colorCode);

            const { computedObsVEF1CVF: computedObsVEF1CVF_pre } = computeDerivedObserved(obsVEF1_pre, obsCVF_pre, obsFEF2575_pre);
            const { computedObsVEF1CVF: computedObsVEF1CVF_post } = computeDerivedObserved(obsVEF1_post, obsCVF_post, obsFEF2575_post);

            // Z-Scores Pre
            const zScoreCVF_pre = calculateZScore(obsCVF_pre, prevCVF, currentSEE.cvf, true);
            const zScoreVEF1_pre = calculateZScore(obsVEF1_pre, prevVEF1, currentSEE.vef1, true);
            const zScoreVEF1CVF_pre = calculateZScore(computedObsVEF1CVF_pre, prevVEF1CVF, currentSEE.vef1cvf, false);
            const zScoreFEF2575_pre = calculateZScore(obsFEF2575_pre, prevFEF2575, currentSEE.fef2575, true);

            // Z-Scores Post
            const zScoreCVF_post = calculateZScore(obsCVF_post, prevCVF, currentSEE.cvf, true);
            const zScoreVEF1_post = calculateZScore(obsVEF1_post, prevVEF1, currentSEE.vef1, true);
            const zScoreVEF1CVF_post = calculateZScore(computedObsVEF1CVF_post, prevVEF1CVF, currentSEE.vef1cvf, false);
            const zScoreFEF2575_post = calculateZScore(obsFEF2575_post, prevFEF2575, currentSEE.fef2575, true);

            // Render Pre Table
            const tbodyPre = document.getElementById('resultsTableBodyPre');
            tbodyPre.innerHTML = '';
            const addRow = (name, obs, prev, lin, z) => {
                const row = tbodyPre.insertRow();
                row.insertCell().textContent = name;
                const cellObs = row.insertCell(); cellObs.textContent = formatValue(obs);
                row.insertCell().textContent = formatValue(prev);
                row.insertCell().textContent = formatValue(lin);
                const cellPerc = row.insertCell(); cellPerc.textContent = calculatePercentage(obs, prev) + '%';
                const cellZ = row.insertCell(); cellZ.textContent = formatValue(z, 3);
                if (obs !== null && lin !== null && obs < lin) {
                    cellObs.classList.add('value-below-lin');
                    cellPerc.classList.add('value-below-lin');
                    cellZ.classList.add('value-below-lin');
                }
            };
            addRow('CVF (L)', obsCVF_pre, prevCVF, linCVF, zScoreCVF_pre);
            addRow('VEF1 (L)', obsVEF1_pre, prevVEF1, linVEF1, zScoreVEF1_pre);
            addRow('VEF1/CVF', computedObsVEF1CVF_pre, prevVEF1CVF, linVEF1CVF, zScoreVEF1CVF_pre);
            addRow('FEF25-75% (L/s)', obsFEF2575_pre, prevFEF2575, linFEF2575, zScoreFEF2575_pre);

            // Render Post Table (Conditional)
            const hasPostBDValues = diagnosis !== "Sadio e Assintomático" && (obsCVF_post !== null || obsVEF1_post !== null || obsFEF2575_post !== null);
            const postSection = document.getElementById('postBdSection');

            if (hasPostBDValues) {
                postSection.style.display = 'block';
                const tbodyPost = document.getElementById('resultsTableBodyPostAndReversibility');
                tbodyPost.innerHTML = '';
                const addPostRow = (name, obsPost, prev, lin, zPost, obsPre, unit) => {
                    const row = tbodyPost.insertRow();
                    row.insertCell().textContent = name;
                    const cellObs = row.insertCell(); cellObs.textContent = formatValue(obsPost);
                    const cellPerc = row.insertCell(); cellPerc.textContent = calculatePercentage(obsPost, prev) + '%';
                    const cellZ = row.insertCell(); cellZ.textContent = formatValue(zPost, 3);
                    if (obsPost !== null && lin !== null && obsPost < lin) {
                        cellObs.classList.add('value-below-lin');
                        cellPerc.classList.add('value-below-lin');
                        cellZ.classList.add('value-below-lin');
                    }
                    const cellAbsDiff = row.insertCell();
                    const cellPercDiff = row.insertCell();

                    const absDiff = (obsPost !== null && obsPre !== null) ? (obsPost - obsPre) : null;
                    const percDiff = calculateDiffPercentOfPredicted(obsPre, obsPost, prev);

                    let fmtAbsDiff = 'N/A';
                    if (absDiff !== null) {
                        if (unit === 'L') fmtAbsDiff = formatValue(absDiff * 1000, 0) + ' mL';
                        else if (unit === 'L/s') fmtAbsDiff = formatValue(absDiff) + ' L/s';
                        else fmtAbsDiff = formatValue(absDiff, 3);
                    }
                    cellAbsDiff.textContent = fmtAbsDiff;
                    cellPercDiff.textContent = formatValue(percDiff) + '%';

                    if (percDiff !== null && percDiff >= 10 && (unit === 'L')) { // Only color significant change for volumes usually
                        cellPercDiff.classList.add('change-significant-green');
                    }
                };
                addPostRow('CVF (L)', obsCVF_post, prevCVF, linCVF, zScoreCVF_post, obsCVF_pre, 'L');
                addPostRow('VEF1 (L)', obsVEF1_post, prevVEF1, linVEF1, zScoreVEF1_post, obsVEF1_pre, 'L');
                addPostRow('VEF1/CVF', computedObsVEF1CVF_post, prevVEF1CVF, linVEF1CVF, zScoreVEF1CVF_post, computedObsVEF1CVF_pre, 'ratio');
                addPostRow('FEF25-75% (L/s)', obsFEF2575_post, prevFEF2575, linFEF2575, zScoreFEF2575_post, obsFEF2575_pre, 'L/s');
            } else {
                postSection.style.display = 'none';
            }

            // Interpretation
            const preBDResult = generateSingleInterpretation(obsCVF_pre, linCVF, obsVEF1_pre, linVEF1, computedObsVEF1CVF_pre, linVEF1CVF, zScoreCVF_pre, "Pré-Broncodilatador");
            document.getElementById('interpretation-text-pre').value = preBDResult.text.replace(/<br>/g, '\n').replace(/<strong>|<\/strong>/g, '');
            const preBDClassification = preBDResult.classification;

            const postBDInterpretationArea = document.getElementById('interpretation-text-post');
            let postBDClassification = null;
            let vef1Change = null;
            let cvfChange = null;

            if (hasPostBDValues) {
                postBDInterpretationArea.style.display = 'block';
                if (computedObsVEF1CVF_post !== null && zScoreCVF_post !== null && obsVEF1_post !== null && obsCVF_post !== null) {
                    const postBDResult = generateSingleInterpretation(obsCVF_post, linCVF, obsVEF1_post, linVEF1, computedObsVEF1CVF_post, linVEF1CVF, zScoreCVF_post, "Pós-Broncodilatador", preBDClassification, obsCVF_pre, obsVEF1_pre, prevCVF, prevVEF1);
                    postBDInterpretationArea.value = postBDResult.text.replace(/<br>/g, '\n').replace(/<strong>|<\/strong>/g, '');
                    postBDClassification = postBDResult.classification;

                    // Calculate changes for conclusion
                    if (obsVEF1_pre !== null && obsVEF1_post !== null && prevVEF1 !== null) {
                        vef1Change = calculateDiffPercentOfPredicted(obsVEF1_pre, obsVEF1_post, prevVEF1);
                    }
                    if (obsCVF_pre !== null && obsCVF_post !== null && prevCVF !== null) {
                        cvfChange = calculateDiffPercentOfPredicted(obsCVF_pre, obsCVF_post, prevCVF);
                    }

                } else {
                    postBDInterpretationArea.value = "Dados Pós-Broncodilatador insuficientes para interpretação completa.";
                }
            } else {
                postBDInterpretationArea.style.display = 'none';
                postBDInterpretationArea.value = "";
            }

            // Generate Conclusion
            const conclusionText = generateConclusion(preBDClassification, postBDClassification, vef1Change, cvfChange);
            document.getElementById('conclusion-text').value = conclusionText;

            // Update Chart (Scatterplot)
            const datasets = [];

            if (zScoreVEF1CVF_pre !== null && zScoreCVF_pre !== null) {
                datasets.push({
                    label: 'Pré-BD',
                    data: [{ x: zScoreVEF1CVF_pre, y: zScoreCVF_pre }],
                    backgroundColor: 'rgba(54, 162, 235, 1)',
                    pointRadius: 8,
                    pointHoverRadius: 10
                });
            }

            if (hasPostBDValues && zScoreVEF1CVF_post !== null && zScoreCVF_post !== null) {
                datasets.push({
                    label: 'Pós-BD',
                    data: [{ x: zScoreVEF1CVF_post, y: zScoreCVF_post }],
                    backgroundColor: 'rgba(75, 192, 192, 1)',
                    pointRadius: 8,
                    pointHoverRadius: 10
                });
            }

            // Update Annotations (Labels)
            const annotations = spirometryChart.options.plugins.annotation.annotations;

            // Clear previous annotations
            Object.keys(annotations).forEach(key => {
                if (key !== 'normal' && key !== 'obstructive' && key !== 'restrictive' && key !== 'mixed') {
                    delete annotations[key];
                }
            });

            if (zScoreVEF1CVF_pre !== null && zScoreCVF_pre !== null) {
                annotations.labelPre = {
                    type: 'label',
                    xValue: zScoreVEF1CVF_pre,
                    yValue: zScoreCVF_pre,
                    yAdjust: -15, // Position above the point
                    content: 'Pré-BD',
                    font: {
                        size: 10,
                        family: "'Inter', sans-serif"
                    },
                    color: 'rgba(54, 162, 235, 1)',
                    position: 'center'
                };
            }

            if (hasPostBDValues && zScoreVEF1CVF_post !== null && zScoreCVF_post !== null) {
                annotations.labelPost = {
                    type: 'label',
                    xValue: zScoreVEF1CVF_post,
                    yValue: zScoreCVF_post,
                    yAdjust: -15, // Position above the point
                    content: 'Pós-BD',
                    font: {
                        size: 10,
                        family: "'Inter', sans-serif"
                    },
                    color: 'rgba(75, 192, 192, 1)',
                    position: 'center'
                };
            }

            spirometryChart.data.datasets = datasets;
            spirometryChart.update();

            // Update Signature
            document.getElementById('signatureDoctorName').textContent = doctorName;
            const details = [];
            if (doctorCRM) details.push(`CRM: ${doctorCRM}`);
            if (doctorSpecialty) details.push(doctorSpecialty);
            document.getElementById('signatureDoctorDetails').textContent = details.join(' - ');

            document.getElementById('doctorSignatureBlock').style.display = 'block';

            document.getElementById('results').style.display = 'block';
            document.getElementById('spirometryForm').style.display = 'none';

            // Show "Enviar Dados (Sadios)" button if applicable
            if (diagnosis === "Sadio e Assintomático") {
                document.getElementById('sendHealthyButton').style.display = 'inline-block';
            } else {
                document.getElementById('sendHealthyButton').style.display = 'none';
            }

            // Auto-save
            autoSaveExam();
        });

        document.getElementById('resetButton').addEventListener('click', function () {
            document.getElementById('spirometryForm').reset();

            // Restore saved values immediately after reset
            const savedDoctorName = localStorage.getItem('doctorName');
            if (savedDoctorName) document.getElementById('doctorName').value = savedDoctorName;
            const savedCRM = localStorage.getItem('doctorCRM');
            if (savedCRM) document.getElementById('doctorCRM').value = savedCRM;
            const savedSpecialty = localStorage.getItem('doctorSpecialty');
            if (savedSpecialty) document.getElementById('doctorSpecialty').value = savedSpecialty;
            const savedClinicName = localStorage.getItem('clinicName');
            if (savedClinicName) document.getElementById('clinicName').value = savedClinicName;

            // Reset date and other defaults
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('examDate').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('ageMonths').value = '0';

            document.getElementById('results').style.display = 'none';
            document.getElementById('spirometryForm').style.display = 'block';
            document.getElementById('ageRangeWarning').style.display = 'none';
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

            // Reset current exam ID for new session
            currentExamId = null;
        });

        document.getElementById('printButton').addEventListener('click', function () {
            const originalTitle = document.title;
            const patientName = document.getElementById('patientName').value.trim();
            const examDateInput = document.getElementById('examDate').value;

            if (patientName && examDateInput) {
                const safePatientName = patientName.replace(/[^a-zA-Z0-9_-\s]/g, '').replace(/\s+/g, '_');
                document.title = `spirometry_${safePatientName}_${examDateInput}`;
            }

            window.print();
            document.title = originalTitle;
        });

        document.getElementById('copyHtmlButton').addEventListener('click', function () {
            const resultsDiv = document.getElementById('results');

            // Create a clone to modify without affecting the display
            const clone = resultsDiv.cloneNode(true);

            // Remove the author/license info from the clone
            const footer = clone.querySelector('.author-license-info');
            if (footer) {
                footer.remove();
            }

            // We need to append the clone to the document to select it, but we can hide it
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            document.body.appendChild(clone);

            const range = document.createRange();
            range.selectNode(clone);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);

            try {
                document.execCommand('copy');
                alert('Resultados copiados (sem rodapé)!');
            } catch (err) {
                console.error('Erro ao copiar:', err);
                alert('Erro ao copiar resultados.');
            } finally {
                window.getSelection().removeAllRanges();
                document.body.removeChild(clone);
            }
        });

        const exportDatabase = () => {
            const database = JSON.parse(localStorage.getItem('spiroDatabase') || '[]');
            if (database.length === 0) {
                alert('Não há exames salvos para exportar.');
                return;
            }

            // CSV Header
            const headers = [
                'ID', 'Data/Hora Salvamento', 'Nome Paciente', 'Data Exame', 'Idade (Anos)', 'Idade (Meses)', 'Altura (cm)', 'Peso (Kg)', 'Sexo', 'Cor', 'Diagnóstico',
                'Médico', 'CRM', 'Clínica',
                'CVF Pré (L)', 'VEF1 Pré (L)', 'FEF25-75 Pré (L/s)',
                'CVF Pós (L)', 'VEF1 Pós (L)', 'FEF25-75 Pós (L/s)',
                'Conclusão'
            ];

            // CSV Rows
            const rows = database.map(exam => [
                exam.id,
                exam.timestamp,
                `"${exam.patientName}"`, // Quote strings that might have commas
                exam.examDate,
                exam.ageYears,
                exam.ageMonths,
                exam.heightCm,
                exam.weightKg || '',
                exam.gender,
                exam.colorCode,
                `"${exam.diagnosis || ''}"`,
                `"${exam.doctorName}"`,
                `"${exam.doctorCRM}"`,
                `"${exam.clinicName}"`,
                exam.obsCVF_pre,
                exam.obsVEF1_pre,
                exam.obsFEF2575_pre,
                exam.obsCVF_post,
                exam.obsVEF1_post,
                exam.obsFEF2575_post,
                `"${(exam.conclusion || '').replace(/"/g, '""').replace(/\n/g, ' ')}"` // Escape quotes and newlines
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');

            // Create Download Link
            // Add BOM (\uFEFF) to ensure Excel opens UTF-8 correctly
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);

            const doctorName = document.getElementById('doctorName').value.trim() || 'Medico';
            const safeDoctorName = doctorName.replace(/[^a-zA-Z0-9_-\s]/g, '').replace(/\s+/g, '_');
            link.setAttribute('download', `data-backup-${safeDoctorName}.csv`);

            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        document.getElementById('exportDbButton').addEventListener('click', exportDatabase);

        const exportHealthyDatabase = () => {
            const database = JSON.parse(localStorage.getItem('spiroDatabase') || '[]');
            const healthyPatients = database.filter(item => item.diagnosis === "Sadio e Assintomático");

            if (healthyPatients.length === 0) {
                alert('Não há pacientes com diagnóstico "Sadio e Assintomático" para exportar.');
                return;
            }

            // CSV Header for Healthy Patients (Anonymized)
            const headers = [
                'ID', 'Nome do Médico', 'CRM', 'Data', 'Sexo', 'Altura (cm)', 'Peso (Kg)',
                'CVF Pré (L)', 'VEF1 Pré (L)', 'FEF25-75 Pré (L/s)',
                'CVF Pós (L)', 'VEF1 Pós (L)', 'FEF25-75 Pós (L/s)'
            ];

            // CSV Rows
            const rows = healthyPatients.map(exam => [
                exam.id,
                `"${exam.doctorName}"`,
                `"${exam.doctorCRM}"`,
                exam.examDate,
                exam.gender,
                exam.heightCm,
                exam.weightKg || '',
                exam.obsCVF_pre,
                exam.obsVEF1_pre,
                exam.obsFEF2575_pre,
                exam.obsCVF_post,
                exam.obsVEF1_post,
                exam.obsFEF2575_post
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');

            // Create Download Link
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);

            const doctorName = document.getElementById('doctorName').value.trim() || 'Medico';
            const doctorCRM = document.getElementById('doctorCRM').value.trim() || 'CRM';
            const safeDoctorName = doctorName.replace(/[^a-zA-Z0-9_-\s]/g, '').replace(/\s+/g, '_');
            const safeCRM = doctorCRM.replace(/[^a-zA-Z0-9_-\s]/g, '');

            const filename = `Sadios_${safeDoctorName}-${safeCRM}.csv`;
            link.setAttribute('download', filename);

            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            return filename; // Return filename for email subject
        };

        const sendHealthyEmail = () => {
            const filename = exportHealthyDatabase();
            if (!filename) return;

            const subject = `Dados Sadios - ${filename}`;
            const body = `Prezados,\n\nSegue em anexo o arquivo ${filename} com os dados dos pacientes sadios.\n\nAtenciosamente,\n${document.getElementById('doctorName').value}`;

            const mailtoLink = `mailto:espirometriabrasil@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

            // Open default email client
            window.location.href = mailtoLink;

            alert('O arquivo CSV foi baixado. Por favor, anexe-o ao e-mail que será aberto em seguida.');
        };

        document.getElementById('sendHealthyButton').addEventListener('click', sendHealthyEmail);

    </script>
</body>

</html>